name: Release

on:
  push:
    branches: ["master"]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: false
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      aur_only:
        description: 'Only publish to AUR (skip version bump)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  verify:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore: bump version'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install Rust toolchain
        run: |
          rustup update stable
          rustup component add clippy
      - name: Run tests
        run: ./scripts/test.sh
      - name: Run clippy
        run: cargo clippy --all-targets --all-features

  release:
    if: github.event_name == 'workflow_dispatch' && inputs.aur_only != true
    needs: verify
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install tooling
        run: |
          pacman -Syu --noconfirm --needed base-devel git openssh python rust github-cli

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: repo
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Bump version
        id: version
        working-directory: repo
        run: |
          new_version=$(python scripts/release.py --bump-type "${{ inputs.bump_type }}")
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Generate .SRCINFO
        working-directory: repo
        run: |
          install -d -m 777 /tmp/makepkg
          runuser -u nobody -- env BUILDDIR=/tmp/makepkg PKGDEST=/tmp/makepkg SRCDEST=/tmp/makepkg makepkg --printsrcinfo | tee .SRCINFO

      - name: Create release PR
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        working-directory: repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          branch="release/v${VERSION}"
          git checkout -b "$branch"
          git add Cargo.toml Cargo.lock PKGBUILD CHANGELOG.md .SRCINFO
          git commit -m "chore: bump version to ${VERSION}" || exit 0
          git push -u origin "$branch"
          gh pr create --title "chore: bump version to ${VERSION}" --body "Automated version bump." --base master
          gh pr merge --auto --squash

  aur-publish:
    needs: verify
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && startsWith(github.event.head_commit.message, 'chore: bump version'))
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install tooling
        run: |
          pacman -Syu --noconfirm --needed base-devel git openssh

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Push to AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          version=$(grep '^pkgver=' PKGBUILD | cut -d= -f2)
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat > ~/.ssh/config << 'EOF'
Host aur.archlinux.org
  IdentityFile ~/.ssh/aur
  User aur
  StrictHostKeyChecking accept-new
EOF
          chmod 600 ~/.ssh/config
          git clone ssh://aur@aur.archlinux.org/hyprspaces.git aur
          cp PKGBUILD .SRCINFO hyprspaces.install aur/
          cd aur
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO hyprspaces.install
          git commit -m "sync from master ${version}" || exit 0
          git push origin master

